
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Tomcat &#8212; Python  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="tomcat">
<h1>Tomcat<a class="headerlink" href="#tomcat" title="Permalink to this headline">¶</a></h1>
<p>We need 3 tomcat instances:</p>
<ul class="simple">
<li><p>one for the proxy and cas webapps</p></li>
<li><p>an other one for geoserver</p></li>
<li><p>the last one for the other webapps</p></li>
</ul>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">tomcat9</span> <span class="n">tomcat9</span><span class="o">-</span><span class="n">user</span>
</pre></div>
</div>
<p>We will deactivate the default tomcat instance, just to be sure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">tomcat9</span> <span class="n">stop</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">disable</span> <span class="n">tomcat9</span>
</pre></div>
</div>
</section>
<section id="keystore">
<h2>Keystore<a class="headerlink" href="#keystore" title="Permalink to this headline">¶</a></h2>
<p>To create a keystore containing a newly generated key, enter the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">keytool</span> <span class="o">-</span><span class="n">genkey</span> \
    <span class="o">-</span><span class="n">alias</span> <span class="n">georchestra_localhost</span> \
    <span class="o">-</span><span class="n">keystore</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">/</span><span class="n">keystore</span> \
    <span class="o">-</span><span class="n">storepass</span> <span class="n">STOREPASSWORD</span> \
    <span class="o">-</span><span class="n">keypass</span> <span class="n">STOREPASSWORD</span> \
    <span class="o">-</span><span class="n">keyalg</span> <span class="n">RSA</span> \
    <span class="o">-</span><span class="n">keysize</span> <span class="mi">2048</span> \
    <span class="o">-</span><span class="n">dname</span> <span class="s2">&quot;CN=localhost, OU=Unknown, O=Unknown, L=Unknown, ST=Unknown, C=FR&quot;</span>
</pre></div>
</div>
<p>… where <code class="docutils literal notranslate"><span class="pre">STOREPASSWORD</span></code> is a password you choose, and the <code class="docutils literal notranslate"><span class="pre">dname</span></code> string is customized.</p>
<section id="ca-certificates">
<h3>CA certificates<a class="headerlink" href="#ca-certificates" title="Permalink to this headline">¶</a></h3>
<p>If the geOrchestra webapps have to communicate with remote HTTPS services, our keystore/trustore has to include the remote CA certificates.</p>
<p>This will be the case, when e.g.:</p>
<ul class="simple">
<li><p>the proxy has to relay an https service</p></li>
<li><p>geonetwork will harvest remote https nodes</p></li>
<li><p>geoserver will proxy remote https ogc services</p></li>
</ul>
<p>In order to trust the default system certificates from the <code class="docutils literal notranslate"><span class="pre">cacerts</span></code> package into our previously created keystore:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">keytool</span> <span class="o">-</span><span class="n">importkeystore</span> \
    <span class="o">-</span><span class="n">srckeystore</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">cacerts</span> \
    <span class="o">-</span><span class="n">destkeystore</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">/</span><span class="n">keystore</span>
</pre></div>
</div>
<p>The password of the srckeystore is “changeit” by default.</p>
</section>
<section id="ssl">
<h3>SSL<a class="headerlink" href="#ssl" title="Permalink to this headline">¶</a></h3>
<p>To import the certificate used by <code class="docutils literal notranslate"><span class="pre">Apache2</span></code> into our keystore, we shall issue the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">keytool</span> <span class="o">-</span><span class="kn">import</span> <span class="o">-</span><span class="n">alias</span> <span class="n">cert_ssl</span> <span class="o">-</span><span class="n">file</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">georchestra</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">georchestra</span><span class="o">.</span><span class="n">crt</span> <span class="o">-</span><span class="n">keystore</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">/</span><span class="n">keystore</span>
</pre></div>
</div>
<p>If you have a Let’s Encrypt certificate using Certbot the file to import is : /etc/letsencrypt/live/[your_sdi_domain_name]/cert.pem. But
since the LetsEncrypt root certificates were already trusted previously, it should not be necessary to do so.</p>
</section>
<section id="ldap-ssl">
<h3>LDAP SSL<a class="headerlink" href="#ldap-ssl" title="Permalink to this headline">¶</a></h3>
<p>In case the LDAP connection uses SSL (which is not the default in the geOrchestra template configuration), its certificate must be added to the keystore.</p>
<p>Here’s how:</p>
<p>First get the public key.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="s2">&quot;&quot;</span> <span class="o">|</span> <span class="n">openssl</span> <span class="n">s_client</span> <span class="o">-</span><span class="n">connect</span> <span class="n">LDAPHOST</span><span class="p">:</span><span class="n">LDAPPORT</span> <span class="o">-</span><span class="n">showcerts</span> <span class="mi">2</span><span class="o">&gt;/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="o">|</span> <span class="n">openssl</span> <span class="n">x509</span> <span class="o">-</span><span class="n">out</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">certfile</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<p>… and then add it to the keystore:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">keytool</span> <span class="o">-</span><span class="kn">import</span> <span class="o">-</span><span class="n">alias</span> <span class="n">cert_ldap</span> <span class="o">-</span><span class="n">file</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">certfile</span><span class="o">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">keystore</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">/</span><span class="n">keystore</span>
</pre></div>
</div>
</section>
<section id="finally">
<h3>Finally,<a class="headerlink" href="#finally" title="Permalink to this headline">¶</a></h3>
<p>verify the list of keys in keystore:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">keytool</span> <span class="o">-</span><span class="n">keystore</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">/</span><span class="n">keystore</span> <span class="o">-</span><span class="nb">list</span>
</pre></div>
</div>
</section>
</section>
<section id="georchestra-datadir">
<h2>geOrchestra datadir<a class="headerlink" href="#georchestra-datadir" title="Permalink to this headline">¶</a></h2>
<p>geOrchestra gets its configuration settings from specific directory, the “georchestra datadir”, which is is usually located in <code class="docutils literal notranslate"><span class="pre">/etc/georchestra</span></code>.</p>
<p>To bootstrap a default datadir:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">git</span> <span class="n">clone</span> <span class="o">-</span><span class="n">b</span> <span class="n">BRANCH_NAME</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">georchestra</span><span class="o">/</span><span class="n">datadir</span><span class="o">.</span><span class="n">git</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">georchestra</span>
</pre></div>
</div>
<p>… where BRANCH_NAME matches the geOrchestra release name (or <code class="docutils literal notranslate"><span class="pre">master</span></code> for development purposes)</p>
</section>
<section id="tomcat-proxycas">
<h2>Tomcat proxycas<a class="headerlink" href="#tomcat-proxycas" title="Permalink to this headline">¶</a></h2>
<section id="create-the-instance">
<h3>Create the instance<a class="headerlink" href="#create-the-instance" title="Permalink to this headline">¶</a></h3>
<p>We will now create an instance named <code class="docutils literal notranslate"><span class="pre">tomcat9-proxycas</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">tomcat9</span><span class="o">-</span><span class="n">instance</span><span class="o">-</span><span class="n">create</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8180</span> <span class="o">-</span><span class="n">c</span> <span class="mi">8105</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">proxycas</span>
</pre></div>
</div>
<p>As indicated in the parameters from the previous command-line, 8180 will be the HTTP port and 8105 the stop port.</p>
<p>Then:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">cp</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">tomcat9</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">proxycas</span>
<span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">proxycas</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">policy</span><span class="o">.</span><span class="n">d</span>
<span class="n">sudo</span> <span class="n">touch</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">proxycas</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">policy</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">empty</span><span class="o">.</span><span class="n">policy</span>
<span class="n">sudo</span> <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">proxycas</span><span class="o">/</span><span class="n">logs</span>
<span class="n">sudo</span> <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">tomcat9</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">proxycas</span><span class="o">/</span><span class="n">logs</span>
<span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">proxycas</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">Catalina</span><span class="o">/</span><span class="n">localhost</span>
<span class="n">sudo</span> <span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">tomcat</span><span class="p">:</span><span class="n">tomcat</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">proxycas</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">.</span><span class="n">service</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">proxycas</span><span class="o">.</span><span class="n">service</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">libexec</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">/</span><span class="n">tomcat</span><span class="o">-</span><span class="n">start</span><span class="o">.</span><span class="n">sh</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">libexec</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">/</span><span class="n">tomcat</span><span class="o">-</span><span class="n">proxycas</span><span class="o">-</span><span class="n">start</span><span class="o">.</span><span class="n">sh</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">tomcat9</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">proxycas</span>
</pre></div>
</div>
<p>Finally, edit the <code class="docutils literal notranslate"><span class="pre">/lib/systemd/system/tomcat9-proxycas</span></code> script and adapt to the created instance:</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- tomcat9.service	2019-06-13 21:26:12.000000000 +0000</span><span class="w"></span>
<span class="gi">+++ tomcat9-proxycas.service	2020-01-20 13:19:10.728000000 +0000</span><span class="w"></span>
<span class="gu">@@ -11,14 +11,14 @@</span><span class="w"></span>

<span class="w"> </span># Configuration<span class="w"></span>
<span class="w"> </span>Environment=&quot;CATALINA_HOME=/usr/share/tomcat9&quot;<span class="w"></span>
<span class="gd">-Environment=&quot;CATALINA_BASE=/var/lib/tomcat9&quot;</span><span class="w"></span>
<span class="gi">+Environment=&quot;CATALINA_BASE=/var/lib/tomcat9-proxycas&quot;</span><span class="w"></span>
<span class="w"> </span>Environment=&quot;CATALINA_TMPDIR=/tmp&quot;<span class="w"></span>
<span class="w"> </span>Environment=&quot;JAVA_OPTS=-Djava.awt.headless=true&quot;<span class="w"></span>

<span class="w"> </span># Lifecycle<span class="w"></span>
<span class="w"> </span>Type=simple<span class="w"></span>
<span class="w"> </span>ExecStartPre=+/usr/libexec/tomcat9/tomcat-update-policy.sh<span class="w"></span>
<span class="gd">-ExecStart=/bin/sh /usr/libexec/tomcat9/tomcat-start.sh</span><span class="w"></span>
<span class="gi">+ExecStart=/bin/sh /usr/libexec/tomcat9/tomcat-proxycas-start.sh</span><span class="w"></span>
<span class="w"> </span>SuccessExitStatus=143<span class="w"></span>
<span class="w"> </span>Restart=on-abort<span class="w"></span>

<span class="gu">@@ -35,7 +35,7 @@</span><span class="w"></span>
<span class="w"> </span>CacheDirectoryMode=750<span class="w"></span>
<span class="w"> </span>ProtectSystem=strict<span class="w"></span>
<span class="w"> </span>ReadWritePaths=/etc/tomcat9/Catalina/<span class="w"></span>
<span class="gd">-ReadWritePaths=/var/lib/tomcat9/webapps/</span><span class="w"></span>
<span class="gi">+ReadWritePaths=/var/lib/tomcat9-proxycas/</span><span class="w"></span>
<span class="w"> </span>ReadWritePaths=/var/log/tomcat9/<span class="w"></span>
<span class="w"> </span>RequiresMountsFor=/var/log/tomcat9<span class="w"></span>
</pre></div>
</div>
<p>And reload the <code class="docutils literal notranslate"><span class="pre">systemd</span></code> configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
</pre></div>
</div>
</section>
<section id="customize-the-java-runtime-and-options">
<h3>Customize the Java runtime and options<a class="headerlink" href="#customize-the-java-runtime-and-options" title="Permalink to this headline">¶</a></h3>
<p>In <code class="docutils literal notranslate"><span class="pre">/etc/default/tomcat9-proxycas</span></code>, we will adapt the JAVA_HOME &amp; JAVA_OPTS environment variables to suit our needs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">JAVA_HOME</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">jvm</span><span class="o">/</span><span class="n">adoptopenjdk</span><span class="o">-</span><span class="mi">8</span><span class="o">-</span><span class="n">hotspot</span><span class="o">-</span><span class="n">amd64</span>
</pre></div>
</div>
<p>And later add these lines (change the <code class="docutils literal notranslate"><span class="pre">STOREPASSWORD</span></code> string):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;$JAVA_OPTS </span><span class="se">\</span>
<span class="s2">              -Dgeorchestra.datadir=/etc/georchestra&quot;</span>

<span class="n">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;$JAVA_OPTS </span><span class="se">\</span>
<span class="s2">              -Xms1G </span><span class="se">\</span>
<span class="s2">              -Xmx1G&quot;</span>

<span class="n">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;$JAVA_OPTS </span><span class="se">\</span>
<span class="s2">              -Djavax.net.ssl.trustStore=/etc/tomcat9/keystore </span><span class="se">\</span>
<span class="s2">              -Djavax.net.ssl.trustStorePassword=STOREPASSWORD&quot;</span>
</pre></div>
</div>
<p>If your connection needs to pass through a proxy, you should also add the relevant options, as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;$JAVA_OPTS </span><span class="se">\</span>
<span class="s2">              -Dhttp.proxyHost=proxy.mycompany.com </span><span class="se">\</span>
<span class="s2">              -Dhttp.proxyPort=XXXX </span><span class="se">\</span>
<span class="s2">              -Dhttps.proxyHost=proxy.mycompany.com </span><span class="se">\</span>
<span class="s2">              -Dhttps.proxyPort=XXXX&quot;</span>
</pre></div>
</div>
<p>Finally, make sure the variables are exported at the end of the script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">JAVA_HOME</span>
<span class="n">export</span> <span class="n">JAVA_OPTS</span>
</pre></div>
</div>
</section>
<section id="configure-connectors">
<h3>Configure connectors<a class="headerlink" href="#configure-connectors" title="Permalink to this headline">¶</a></h3>
<p>In <code class="docutils literal notranslate"><span class="pre">/var/lib/tomcat-proxycas/conf/server.xml</span></code>, find the place where the HTTP connector is defined, and check that the port is correctly set:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="o">&lt;</span><span class="n">Connector</span> <span class="n">port</span><span class="o">=</span><span class="s2">&quot;8180&quot;</span> <span class="n">protocol</span><span class="o">=</span><span class="s2">&quot;HTTP/1.1&quot;</span>
               <span class="n">connectionTimeout</span><span class="o">=</span><span class="s2">&quot;20000&quot;</span>
               <span class="n">URIEncoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span>
               <span class="n">redirectPort</span><span class="o">=</span><span class="s2">&quot;8443&quot;</span>
                <span class="o">/&gt;</span>
</pre></div>
</div>
<p>… which should have been done by the <code class="docutils literal notranslate"><span class="pre">tomcat9-instance-create</span></code> script.</p>
</section>
<section id="start-the-instance">
<h3>Start the instance<a class="headerlink" href="#start-the-instance" title="Permalink to this headline">¶</a></h3>
<p>Finally, we make the instance start by default with the OS:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">enable</span> <span class="n">tomcat9</span><span class="o">-</span><span class="n">proxycas</span>
</pre></div>
</div>
<p>and check if we can now start it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">service</span> <span class="n">tomcat9</span><span class="o">-</span><span class="n">proxycas</span> <span class="n">start</span>
</pre></div>
</div>
<p>In case of issues, one can consult the logs using the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">journalctl</span> <span class="o">-</span><span class="n">xe</span>
</pre></div>
</div>
</section>
</section>
<section id="tomcat-georchestra">
<h2>Tomcat geOrchestra<a class="headerlink" href="#tomcat-georchestra" title="Permalink to this headline">¶</a></h2>
<section id="id1">
<h3>Create the instance<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>The same procedure as before is followed, we will only adapt names and ports.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">tomcat9</span><span class="o">-</span><span class="n">instance</span><span class="o">-</span><span class="n">create</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8280</span> <span class="o">-</span><span class="n">c</span> <span class="mi">8205</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">georchestra</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">tomcat9</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">georchestra</span>
<span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">georchestra</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">policy</span><span class="o">.</span><span class="n">d</span>
<span class="n">sudo</span> <span class="n">touch</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">georchestra</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">policy</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">empty</span><span class="o">.</span><span class="n">policy</span>
<span class="n">sudo</span> <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">georchestra</span><span class="o">/</span><span class="n">logs</span>
<span class="n">sudo</span> <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">tomcat9</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">georchestra</span><span class="o">/</span><span class="n">logs</span>
<span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">georchestra</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">Catalina</span><span class="o">/</span><span class="n">localhost</span>
<span class="n">sudo</span> <span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">tomcat</span><span class="p">:</span><span class="n">tomcat</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">georchestra</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">.</span><span class="n">service</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">georchestra</span><span class="o">.</span><span class="n">service</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">libexec</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">/</span><span class="n">tomcat</span><span class="o">-</span><span class="n">start</span><span class="o">.</span><span class="n">sh</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">libexec</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">/</span><span class="n">tomcat</span><span class="o">-</span><span class="n">georchestra</span><span class="o">-</span><span class="n">start</span><span class="o">.</span><span class="n">sh</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">tomcat9</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">georchestra</span>
</pre></div>
</div>
<p>Adapt the script in libexec, so that it will source the expected file in <code class="docutils literal notranslate"><span class="pre">/etc/default</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the service settings</span>
<span class="o">.</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">georchestra</span>
</pre></div>
</div>
<p>Finally, we need to adapt the systemd unit file for this instance:</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- tomcat9.service	2019-06-13 21:26:12.000000000 +0000</span><span class="w"></span>
<span class="gi">+++ tomcat9-georchestra.service	2020-01-20 13:34:21.760000000 +0000</span><span class="w"></span>
<span class="gu">@@ -11,14 +11,14 @@</span><span class="w"></span>

<span class="w"> </span># Configuration<span class="w"></span>
<span class="w"> </span>Environment=&quot;CATALINA_HOME=/usr/share/tomcat9&quot;<span class="w"></span>
<span class="gd">-Environment=&quot;CATALINA_BASE=/var/lib/tomcat9&quot;</span><span class="w"></span>
<span class="gi">+Environment=&quot;CATALINA_BASE=/var/lib/tomcat9-georchestra&quot;</span><span class="w"></span>
<span class="w"> </span>Environment=&quot;CATALINA_TMPDIR=/tmp&quot;<span class="w"></span>
<span class="w"> </span>Environment=&quot;JAVA_OPTS=-Djava.awt.headless=true&quot;<span class="w"></span>

<span class="w"> </span># Lifecycle<span class="w"></span>
<span class="w"> </span>Type=simple<span class="w"></span>
<span class="w"> </span>ExecStartPre=+/usr/libexec/tomcat9/tomcat-update-policy.sh<span class="w"></span>
<span class="gd">-ExecStart=/bin/sh /usr/libexec/tomcat9/tomcat-start.sh</span><span class="w"></span>
<span class="gi">+ExecStart=/bin/sh /usr/libexec/tomcat9/tomcat-georchestra-start.sh</span><span class="w"></span>
<span class="w"> </span>SuccessExitStatus=143<span class="w"></span>
<span class="w"> </span>Restart=on-abort<span class="w"></span>

<span class="gu">@@ -35,7 +35,7 @@</span><span class="w"></span>
<span class="w"> </span>CacheDirectoryMode=750<span class="w"></span>
<span class="w"> </span>ProtectSystem=strict<span class="w"></span>
<span class="w"> </span>ReadWritePaths=/etc/tomcat9/Catalina/<span class="w"></span>
<span class="gd">-ReadWritePaths=/var/lib/tomcat9/webapps/</span><span class="w"></span>
<span class="gi">+ReadWritePaths=/var/lib/tomcat9-georchestra/</span><span class="w"></span>
<span class="gi">+ReadWritePaths=/opt/geonetwork_data_dir/</span><span class="w"></span>
<span class="gi">+ReadWritePaths=/opt/extracts/</span><span class="w"></span>
<span class="w"> </span>ReadWritePaths=/var/log/tomcat9/<span class="w"></span>
<span class="w"> </span>RequiresMountsFor=/var/log/tomcat9<span class="w"></span>
</pre></div>
</div>
<p>Note: the <code class="docutils literal notranslate"><span class="pre">ReadWritePaths</span></code> parameters above should be set in the tomcat unit files accordingly. Here we assumed that
GeoNetwork (which requires RW access to /opt/geonetwork_data_dir) and extractorapp (/opt/extracts) will be deployed
in this instance.</p>
<p>Reload the <code class="docutils literal notranslate"><span class="pre">systemd</span></code> configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">tomcat9</span><span class="o">-</span><span class="n">georchestra</span>
</pre></div>
</div>
</section>
<section id="customize-java-runtime-options">
<h3>Customize Java runtime &amp; options<a class="headerlink" href="#customize-java-runtime-options" title="Permalink to this headline">¶</a></h3>
<p>In <code class="docutils literal notranslate"><span class="pre">/etc/default/tomcat9-georchestra</span></code>, we need to adapt the JAVA_HOME &amp; JAVA_OPTS variables as well:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">JAVA_HOME</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">jvm</span><span class="o">/</span><span class="n">adoptopenjdk</span><span class="o">-</span><span class="mi">8</span><span class="o">-</span><span class="n">hotspot</span><span class="o">-</span><span class="n">amd64</span>
</pre></div>
</div>
<p>And later add these lines (change the <code class="docutils literal notranslate"><span class="pre">STOREPASSWORD</span></code> string):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;$JAVA_OPTS </span><span class="se">\</span>
<span class="s2">              -Dgeorchestra.datadir=/etc/georchestra&quot;</span>

<span class="n">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;$JAVA_OPTS </span><span class="se">\</span>
<span class="s2">              -Xms6G </span><span class="se">\</span>
<span class="s2">              -Xmx6G&quot;</span>

<span class="n">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;$JAVA_OPTS </span><span class="se">\</span>
<span class="s2">              -Djavax.net.ssl.trustStore=/etc/tomcat9/keystore </span><span class="se">\</span>
<span class="s2">              -Djavax.net.ssl.trustStorePassword=STOREPASSWORD&quot;</span>

<span class="n">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;$JAVA_OPTS </span><span class="se">\</span>
<span class="s2">              -Djava.util.prefs.userRoot=/tmp </span><span class="se">\</span>
<span class="s2">              -Djava.util.prefs.systemRoot=/tmp&quot;</span>
</pre></div>
</div>
<p>This allocates 6GB of your server RAM to all geOrchestra webapps (except proxy, cas and geoserver, which are located in other tomcat instances).</p>
<section id="geonetwork-3-x-georchestra-15-12-and-above">
<h4>GeoNetwork 3.x (geOrchestra 15.12 and above)<a class="headerlink" href="#geonetwork-3-x-georchestra-15-12-and-above" title="Permalink to this headline">¶</a></h4>
<p>If GeoNetwork 3.x is deployed, some extra java environment variables will be
required, because almost everything related to the configuration and the
geOrchestra integration has been exported outside of the webapp, into the geOrchestra datadir.</p>
<p>GeoNetwork also comes with its own “datadir”, to store specific materials related to its own operation (to store uploaded content for example). One
can create the directory using the following commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">geonetwork_data_dir</span>
<span class="n">sudo</span> <span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">tomcat</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">geonetwork_data_dir</span>
</pre></div>
</div>
<p>Customize the <code class="docutils literal notranslate"><span class="pre">/etc/georchestra/geonetwork/geonetwork.properties</span></code>, so that the
<code class="docutils literal notranslate"><span class="pre">geonetwork.dir</span></code> reflects the path created during the previous step, e.g. <code class="docutils literal notranslate"><span class="pre">/opt/geonetwork_data_dir</span></code>.</p>
<p>Then ensure your tomcat has the following environment variable set:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;$JAVA_OPTS </span><span class="se">\</span>
<span class="s2">              -Dgeonetwork.jeeves.configuration.overrides.file=/etc/georchestra/geonetwork/config/config-overrides-georchestra.xml&quot;</span>
</pre></div>
</div>
<p>Note: You can also override every geonetwork sub-data-directories by modifying
the <code class="docutils literal notranslate"><span class="pre">/etc/georchestra/geonetwork/geonetwork.properties</span></code> file for convenience.</p>
</section>
<section id="viewer">
<h4>Viewer<a class="headerlink" href="#viewer" title="Permalink to this headline">¶</a></h4>
<p>If the “mapfishapp” viewer application is deployed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;$JAVA_OPTS </span><span class="se">\</span>
<span class="s2">               -Dmapfish-print-config=/etc/georchestra/mapfishapp/print/config.yaml </span><span class="se">\</span>
<span class="s2">               -Dorg.geotools.referencing.forceXY=true&quot;</span>
</pre></div>
</div>
</section>
<section id="extractor">
<h4>Extractor<a class="headerlink" href="#extractor" title="Permalink to this headline">¶</a></h4>
<p>If the extractor application is deployed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;$JAVA_OPTS </span><span class="se">\</span>
<span class="s2">               -Dorg.geotools.referencing.forceXY=true </span><span class="se">\</span>
<span class="s2">               -Dextractor.storage.dir=/path/to/temporary/extracts/&quot;</span>
</pre></div>
</div>
<p>… where <code class="docutils literal notranslate"><span class="pre">/path/to/temporary/extracts/</span></code> is a directory owned by tomcat in a dedicated server partition.</p>
<p>If one of geonetwork or extractorapp is deployed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;$JAVA_OPTS </span><span class="se">\</span>
<span class="s2">               -Djava.util.prefs.userRoot=/var/lib/tomcat9-georchestra/temp </span><span class="se">\</span>
<span class="s2">               -Djava.util.prefs.systemRoot=/var/lib/tomcat9-georchestra/temp&quot;</span>
</pre></div>
</div>
<p>If your connection to the internet requires to pass through a proxy, you should also add the <code class="docutils literal notranslate"><span class="pre">-Dhttp.proxy*</span></code> options here.</p>
<p>Finally, export both variables:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">JAVA_HOME</span>
<span class="n">export</span> <span class="n">JAVA_OPTS</span>
</pre></div>
</div>
</section>
</section>
<section id="configure-connector">
<h3>Configure connector<a class="headerlink" href="#configure-connector" title="Permalink to this headline">¶</a></h3>
<p>Normally, the <code class="docutils literal notranslate"><span class="pre">tomcat9-instance-create</span></code> should have correctly set the listening port accordingly ; but we want to check the connector parameters:</p>
<p>In <code class="docutils literal notranslate"><span class="pre">/var/lib/tomcat9-georchestra/conf/server.xml</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="o">&lt;</span><span class="n">Connector</span> <span class="n">port</span><span class="o">=</span><span class="s2">&quot;8280&quot;</span> <span class="n">protocol</span><span class="o">=</span><span class="s2">&quot;HTTP/1.1&quot;</span>
               <span class="n">connectionTimeout</span><span class="o">=</span><span class="s2">&quot;20000&quot;</span>
               <span class="n">URIEncoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span>
               <span class="n">scheme</span><span class="o">=</span><span class="s2">&quot;https&quot;</span>
               <span class="n">proxyName</span><span class="o">=</span><span class="s2">&quot;georchestra.mydomain.org&quot;</span>
               <span class="n">proxyPort</span><span class="o">=</span><span class="s2">&quot;443&quot;</span>
               <span class="n">redirectPort</span><span class="o">=</span><span class="s2">&quot;8443&quot;</span> <span class="o">/&gt;</span>
</pre></div>
</div>
<p>Set proxyName to your service’s fqdn.</p>
</section>
<section id="id2">
<h3>Start the instance<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">tomcat9</span><span class="o">-</span><span class="n">georchestra</span> <span class="n">start</span>
</pre></div>
</div>
</section>
</section>
<section id="tomcat-geoserver">
<h2>Tomcat GeoServer<a class="headerlink" href="#tomcat-geoserver" title="Permalink to this headline">¶</a></h2>
<section id="id3">
<h3>Create the instance<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">tomcat9</span><span class="o">-</span><span class="n">instance</span><span class="o">-</span><span class="n">create</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8380</span> <span class="o">-</span><span class="n">c</span> <span class="mi">8305</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">geoserver0</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">tomcat9</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">geoserver0</span>
<span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">geoserver0</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">policy</span><span class="o">.</span><span class="n">d</span>
<span class="n">sudo</span> <span class="n">touch</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">geoserver0</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">policy</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">empty</span><span class="o">.</span><span class="n">policy</span>
<span class="n">sudo</span> <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">geoserver0</span><span class="o">/</span><span class="n">logs</span>
<span class="n">sudo</span> <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">tomcat9</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">geoserver0</span><span class="o">/</span><span class="n">logs</span>
<span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">geoserver0</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">Catalina</span><span class="o">/</span><span class="n">localhost</span>
<span class="n">sudo</span> <span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">tomcat</span><span class="p">:</span><span class="n">tomcat</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">geoserver0</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">.</span><span class="n">service</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">geoserver0</span><span class="o">.</span><span class="n">service</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">libexec</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">/</span><span class="n">tomcat</span><span class="o">-</span><span class="n">start</span><span class="o">.</span><span class="n">sh</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">libexec</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">/</span><span class="n">tomcat</span><span class="o">-</span><span class="n">geoserver0</span><span class="o">-</span><span class="n">start</span><span class="o">.</span><span class="n">sh</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">tomcat9</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">geoserver0</span>
</pre></div>
</div>
<p>Adapt the <code class="docutils literal notranslate"><span class="pre">/usr/libexec/tomcat9/tomcat-geoserver0-start.sh</span></code> so that it sources the <code class="docutils literal notranslate"><span class="pre">/etc/default/tomcat9-geoserver0</span></code> file instead:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the service settings</span>
<span class="o">.</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">tomcat9</span><span class="o">-</span><span class="n">geoserver0</span>
</pre></div>
</div>
<p>And adapt the previously created systemd unit file in <code class="docutils literal notranslate"><span class="pre">/lib/systemd/system/tomcat9-geoserver0.service</span></code>:</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- tomcat9.service	2019-06-13 21:26:12.000000000 +0000</span><span class="w"></span>
<span class="gi">+++ tomcat9-geoserver0.service	2020-01-20 13:46:12.968000000 +0000</span><span class="w"></span>
<span class="gu">@@ -11,14 +11,14 @@</span><span class="w"></span>

<span class="w"> </span># Configuration<span class="w"></span>
<span class="w"> </span>Environment=&quot;CATALINA_HOME=/usr/share/tomcat9&quot;<span class="w"></span>
<span class="gd">-Environment=&quot;CATALINA_BASE=/var/lib/tomcat9&quot;</span><span class="w"></span>
<span class="gi">+Environment=&quot;CATALINA_BASE=/var/lib/tomcat9-geoserver0&quot;</span><span class="w"></span>
<span class="w"> </span>Environment=&quot;CATALINA_TMPDIR=/tmp&quot;<span class="w"></span>
<span class="w"> </span>Environment=&quot;JAVA_OPTS=-Djava.awt.headless=true&quot;<span class="w"></span>

<span class="w"> </span># Lifecycle<span class="w"></span>
<span class="w"> </span>Type=simple<span class="w"></span>
<span class="w"> </span>ExecStartPre=+/usr/libexec/tomcat9/tomcat-update-policy.sh<span class="w"></span>
<span class="gd">-ExecStart=/bin/sh /usr/libexec/tomcat9/tomcat-start.sh</span><span class="w"></span>
<span class="gi">+ExecStart=/bin/sh /usr/libexec/tomcat9/tomcat-geoserver0-start.sh</span><span class="w"></span>
<span class="w"> </span>SuccessExitStatus=143<span class="w"></span>
<span class="w"> </span>Restart=on-abort<span class="w"></span>

<span class="gu">@@ -35,7 +35,7 @@</span><span class="w"></span>
<span class="w"> </span>CacheDirectoryMode=750<span class="w"></span>
<span class="w"> </span>ProtectSystem=strict<span class="w"></span>
<span class="w"> </span>ReadWritePaths=/etc/tomcat9/Catalina/<span class="w"></span>
<span class="gd">-ReadWritePaths=/var/lib/tomcat9/webapps/</span><span class="w"></span>
<span class="gi">+ReadWritePaths=/var/lib/tomcat9-geoserver0/</span><span class="w"></span>
<span class="gi">+ReadWritePaths=/opt/geoserver_data_dir</span><span class="w"></span>
<span class="gi">+ReadWritePaths=/opt/geowebcache_cache_dir</span><span class="w"></span>
<span class="w"> </span>ReadWritePaths=/var/log/tomcat9/<span class="w"></span>
<span class="w"> </span>RequiresMountsFor=/var/log/tomcat9<span class="w"></span>
</pre></div>
</div>
<p>Enable the instance:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">tomcat9</span><span class="o">-</span><span class="n">georchestra</span>
</pre></div>
</div>
<p>Locate tomcat’s <code class="docutils literal notranslate"><span class="pre">conf/context.xml</span></code> and update the <code class="docutils literal notranslate"><span class="pre">&lt;Context&gt;</span></code> tag in order to
set <code class="docutils literal notranslate"><span class="pre">useRelativeRedirects</span></code> to <code class="docutils literal notranslate"><span class="pre">false</span></code>, eg:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;Context</span> <span class="na">useRelativeRedirects=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;WatchedResource&gt;</span>WEB-INF/web.xml<span class="nt">&lt;/WatchedResource&gt;</span>
    <span class="nt">&lt;WatchedResource&gt;</span>${catalina.base}/conf/web.xml<span class="nt">&lt;/WatchedResource&gt;</span>
<span class="nt">&lt;/Context&gt;</span>
</pre></div>
</div>
<p>See <a class="reference external" href="https://github.com/georchestra/georchestra/pull/1847">#1857</a> for the
motivations behind setting this parameter.</p>
</section>
<section id="id4">
<h3>Customize Java runtime &amp; options<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>In <code class="docutils literal notranslate"><span class="pre">/etc/default/tomcat9-geoserver0</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">JAVA_HOME</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">jvm</span><span class="o">/</span><span class="n">adoptopenjdk</span><span class="o">-</span><span class="mi">8</span><span class="o">-</span><span class="n">hotspot</span><span class="o">-</span><span class="n">amd64</span>
</pre></div>
</div>
<p>And later add these lines:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;$JAVA_OPTS </span><span class="se">\</span>
<span class="s2">            -DGEOSERVER_DATA_DIR=/opt/geoserver_data_dir </span><span class="se">\</span>
<span class="s2">            -DGEOWEBCACHE_CACHE_DIR=/opt/geowebcache_cache_dir&quot;</span>

<span class="n">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;$JAVA_OPTS </span><span class="se">\</span>
<span class="s2">            -Dfile.encoding=UTF8 </span><span class="se">\</span>
<span class="s2">            -Djavax.servlet.request.encoding=UTF-8 </span><span class="se">\</span>
<span class="s2">            -Djavax.servlet.response.encoding=UTF-8&quot;</span>

<span class="n">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;$JAVA_OPTS </span><span class="se">\</span>
<span class="s2">            -Xms2G -Xmx2G&quot;</span>

<span class="n">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;$JAVA_OPTS </span><span class="se">\</span>
<span class="s2">            -server </span><span class="se">\</span>
<span class="s2">            -XX:+UseParNewGC </span><span class="se">\</span>
<span class="s2">            -XX:ParallelGCThreads=2 </span><span class="se">\</span>
<span class="s2">            -XX:SoftRefLRUPolicyMSPerMB=36000 </span><span class="se">\</span>
<span class="s2">            -XX:+UseConcMarkSweepGC&quot;</span>
</pre></div>
</div>
<p>This allocates 2GB of your server RAM to GeoServer.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">/opt/geoserver_data_dir</span></code> directory should be owned by tomcat, and created by checking out this repository <a class="reference external" href="https://github.com/georchestra/geoserver_minimal_datadir">georchestra/geoserver_minimal_datadir</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">git</span> <span class="n">clone</span> <span class="o">-</span><span class="n">b</span> <span class="n">master</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">georchestra</span><span class="o">/</span><span class="n">geoserver_minimal_datadir</span><span class="o">.</span><span class="n">git</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">geoserver_data_dir</span>
<span class="n">sudo</span> <span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">tomcat</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">geoserver_data_dir</span>
<span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">geowebcache_cache_dir</span>
<span class="n">sudo</span> <span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">tomcat</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">geowebcache_cache_dir</span>

</pre></div>
</div>
<p>Note that this data dir holds <strong>several branches</strong>: please refer to the repository <a class="reference external" href="https://github.com/georchestra/geoserver_minimal_datadir/blob/master/README.md">README</a> in order to <strong>choose the correct one</strong>.</p>
<p>As before (change the <code class="docutils literal notranslate"><span class="pre">STOREPASSWORD</span></code> string):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;$JAVA_OPTS </span><span class="se">\</span>
<span class="s2">              -Djavax.net.ssl.trustStore=/etc/tomcat9/keystore </span><span class="se">\</span>
<span class="s2">              -Djavax.net.ssl.trustStorePassword=STOREPASSWORD&quot;</span>
</pre></div>
</div>
<p>In case your connection to the internet needs to pass through a proxy, you should also add the <code class="docutils literal notranslate"><span class="pre">-Dhttp.proxyHost=xxxx</span> <span class="pre">-Dhttp.proxyPort=xxxx</span></code> options here.</p>
</section>
<section id="notes-about-the-s3-geotiff-module">
<h3>Notes about the s3-geotiff module<a class="headerlink" href="#notes-about-the-s3-geotiff-module" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">s3-geotiff</span></code> module which allows to optimally store geotiff files onto s3-compatible buckets is now included by default. If you plan
to use its features in your GeoServer instance, you will also have to add the following JAVA_OPTS options:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;$JAVA_OPTS </span><span class="se">\</span>
<span class="s2">            -Ds3.caching.ehCacheConfig=/etc/georchestra/geoserver/s3-geotiff/s3-geotiff-ehcache.xml </span><span class="se">\</span>
<span class="s2">            -Ds3.properties.location=/etc/georchestra/geoserver/s3-geotiff/s3.properties </span><span class="se">\&quot;</span>
</pre></div>
</div>
</section>
<section id="note-for-geofence-users">
<h3>Note for geofence users<a class="headerlink" href="#note-for-geofence-users" title="Permalink to this headline">¶</a></h3>
<p>If geofence is activated in our geoserver, one will require some specific environment variables set. in the <code class="docutils literal notranslate"><span class="pre">/etc/default/tomcat9-geoserver0</span></code> file, consider adding:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;$JAVA_OPTS </span><span class="se">\</span>
<span class="s2">           -Dgeofence-ovr=file:/etc/georchestra/geoserver/geofence/geofence-datasource-ovr.properties&quot;</span>
</pre></div>
</div>
</section>
<section id="note-for-geowebcache-users">
<h3>Note for geowebcache users<a class="headerlink" href="#note-for-geowebcache-users" title="Permalink to this headline">¶</a></h3>
<p>GeoWebCache can be used either as a standalone webapp or integrated to GeoServer. If we want to go for the first option, we will also require the following JAVA_OPTS options:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;$JAVA_OPTS</span>
           <span class="o">-</span><span class="n">DGEOWEBCACHE_CONFIG_DIR</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">geowebcache_datadir</span> \
           <span class="o">-</span><span class="n">DGEOWEBCACHE_CACHE_DIR</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">geowebcache_tiles</span><span class="s2">&quot;</span>
</pre></div>
</div>
</section>
<section id="exporting-java-variables">
<h3>Exporting Java variables<a class="headerlink" href="#exporting-java-variables" title="Permalink to this headline">¶</a></h3>
<p>Finally, do not forget to export the variables at the end of the script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">JAVA_HOME</span>
<span class="n">export</span> <span class="n">JAVA_OPTS</span>
</pre></div>
</div>
</section>
<section id="configure-the-connector">
<h3>Configure the connector<a class="headerlink" href="#configure-the-connector" title="Permalink to this headline">¶</a></h3>
<p>For GeoServer, it is advised to lower the number of simultaneous threads handling incoming requests.
By default Tomcat assumes 200 threads, but experiments show that 20 is a better value.</p>
<p>It is also required to set the <code class="docutils literal notranslate"><span class="pre">scheme</span></code>, <code class="docutils literal notranslate"><span class="pre">proxyPort</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">proxyName</span></code> parameters, as follows in <code class="docutils literal notranslate"><span class="pre">/var/lib/tomcat9-geoserver0/conf/server.xml</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="o">&lt;</span><span class="n">Connector</span> <span class="n">port</span><span class="o">=</span><span class="s2">&quot;8380&quot;</span> <span class="n">protocol</span><span class="o">=</span><span class="s2">&quot;HTTP/1.1&quot;</span>
               <span class="n">connectionTimeout</span><span class="o">=</span><span class="s2">&quot;20000&quot;</span>
               <span class="n">URIEncoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span>
               <span class="n">maxThreads</span><span class="o">=</span><span class="s2">&quot;20&quot;</span>
               <span class="n">minSpareThreads</span><span class="o">=</span><span class="s2">&quot;20&quot;</span>
               <span class="n">scheme</span><span class="o">=</span><span class="s2">&quot;https&quot;</span>
               <span class="n">proxyName</span><span class="o">=</span><span class="s2">&quot;georchestra.mydomain.org&quot;</span>
               <span class="n">proxyPort</span><span class="o">=</span><span class="s2">&quot;443&quot;</span>
               <span class="n">redirectPort</span><span class="o">=</span><span class="s2">&quot;8443&quot;</span> <span class="o">/&gt;</span>
</pre></div>
</div>
<p>… where <code class="docutils literal notranslate"><span class="pre">proxyName</span></code> is set to your service’s fqdn.</p>
</section>
<section id="id5">
<h3>Start the instance<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">tomcat9</span><span class="o">-</span><span class="n">geoserver0</span> <span class="n">start</span>
</pre></div>
</div>
</section>
<section id="in-case-of-troubles-with-the-geoserver-ui">
<h3>In case of troubles with the GeoServer UI<a class="headerlink" href="#in-case-of-troubles-with-the-geoserver-ui" title="Permalink to this headline">¶</a></h3>
<p>While testing the following setup guide, we stumbled upon a strange behaviour of the geoserver UI. If you
are encountering some strange response from GeoServer (“400 Bad Request”), it might be due to the following <a class="reference external" href="https://osgeo-org.atlassian.net/browse/GEOS-9353">upstream
issue</a>.</p>
<p>As described in the issue, this can be solved by changing geoserver’s <code class="docutils literal notranslate"><span class="pre">web.xml</span></code> file, and adding the following context variable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">context</span><span class="o">-</span><span class="n">param</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">param</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span><span class="n">GEOSERVER_CSRF_WHITELIST</span><span class="o">&lt;/</span><span class="n">param</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">param</span><span class="o">-</span><span class="n">value</span><span class="o">&gt;</span><span class="n">georchestra</span><span class="o">.</span><span class="n">mydomain</span><span class="o">.</span><span class="n">org</span><span class="o">&lt;/</span><span class="n">param</span><span class="o">-</span><span class="n">value</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">context</span><span class="o">-</span><span class="n">param</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>As described in the <a class="reference external" href="https://docs.geoserver.org/stable/en/user/security/webadmin/csrf.html">official GeoServer documentation</a>, you should also be able to use
a JAVA_OPTS environment variable (eg <code class="docutils literal notranslate"><span class="pre">-DGEOSERVER_CSRF_WHITELIST=georchestra.mydomain.org</span></code>) instead of the previous modification.</p>
<p>Of course you will have to adapt the parameter to suit your setup. Setups based on the Jetty Servlet Container do not seem to be affected.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Python</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.4.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/setup/tomcat.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>